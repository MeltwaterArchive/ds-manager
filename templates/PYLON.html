<head>
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='tablesorter/themes/orange/style.css') }}">

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="{{
  url_for('static', filename='jquery.js') }}">\x3C/script>')</script>
<script type="text/javascript" src="{{
  url_for('static', filename='tablesorter/jquery.tablesorter.js') }}"></script>
<script type=text/javascript>
  $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

  $(document).ready(function() {

    $('#pylontable').tablesorter();

    $('input#pylon_raw').bind('click', function() {
      $.getJSON($SCRIPT_ROOT + '/pylon_get_raw', 
      function(data) {
        formatted = pylon_output_format(data);
        var html_formatted = pylon_output_format_html(formatted);
        $.post($SCRIPT_ROOT + '/set_pylon_export', {output:formatted});
        $("#pylon_output").html(html_formatted);
      });
      return false;
    });

    $('#pylon_refresh').bind('click', function() {
      //only get data if we're opening 
      $('#pylonget').css('display') == 'none';
      $('#pylonget').slideToggle("fast");
      // loading gif
      $('#pylon_load').css('display', 'block');
      $.get($SCRIPT_ROOT + '/pylon_get', 'reload=1', function(data){
        $('#pylonget').html(data).slideToggle("fast");
        $('#pylon_load').css('display', 'none');
      });
    });

    //update ratelimit
    $(':button,h3').click(function() {
      $.get($SCRIPT_ROOT + '/update_ratelimit', function(data){
        $('#ratelimit').text(data);
      });
    });

    // helper functions

    //stringify the json so that its formatted nicely for output (we export this as well)
    var pylon_output_format = function(data){
      return JSON.stringify(data.out, null, 4);
    }

    //add the rest of the output html to the formatted output
    var pylon_output_format_html = function(formatted){
      var html_formatted = "";
      var clear_output= "<span class='output_control' onclick='document.getElementById(\"pylon_output\").innerHTML = \"\";'><a href='#pylon'>clear output</a></span>";
      var export_output= "<span class='output_control'><a href='/get_pylon_export/output.txt'>export output.txt</a></span>";
      var output_control = "<div class='output_control_container'>" + clear_output + export_output + "</div>";
      html_formatted = "<div class='inner_output'><pre>" + formatted + "</pre></div>" + output_control;

      return html_formatted;
    }

  });
</script>
</head>
<body>
  <span class="output_buttons"> 
    <input type="button" id="pylon_raw" value="raw output">
  </span>
  <span class="update_buttons">
    <input type="button" id="pylon_refresh" class=refresh title="reload" value=" ">
  </span>
  <div id=pylon_output class="out">[output]</div>
  {% if raw %}
  <table id="pylontable" class="tablesorter">
    <thead>
      <tr>
        <th>name</th>
        <th>hash</th>
        <th>identity</th>
        <th>start</th>
        <th>end</th>
        <th>remaining index capacity</th>
        <th>status</th>
        <th>volume</th>
      </tr>
    </thead>
    <tbody>
  {% for i in raw %}
    {% for r in i %}
      <tr>
        <td>{{r['name']}}</td>
        <td>{{r['hash']}}</td>
        <td>{{r['identity_label']}}</td>
        <td>{{r['start']}}</td>
        <td>{{r['end']}}</td>
        <td>{{r['remaining_index_capacity']}}</td>
        <td>{{r['status']}}</td>
        <td>{{r['volume']}}</td>
      </tr>
    {% endfor %}
  {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p> [ No recordings found ] </p>
  {% endif %}
</body>